name: Build TrustTunnel IPK

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      arch:
        description: 'Target architecture'
        required: true
        default: 'all'
        type: choice
        options: [aarch64, mipsel, armv7, x86_64, all]
      client_version:
        description: 'TrustTunnelClient release tag'
        required: false
        default: 'v0.99.105'

env:
  CLIENT_VERSION: ${{ github.event.inputs.client_version || 'v0.99.105' }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          if [ "${{ github.event.inputs.arch }}" = "all" ] || [ -z "${{ github.event.inputs.arch }}" ]; then
            echo 'matrix=["aarch64","mipsel","armv7","x86_64"]' >> $GITHUB_OUTPUT
          else
            echo 'matrix=["${{ github.event.inputs.arch }}"]' >> $GITHUB_OUTPUT
          fi

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set target triple
        id: target
        run: |
          case "${{ matrix.arch }}" in
            aarch64) echo "triple=aarch64-unknown-linux-musl" >> $GITHUB_OUTPUT
                     echo "client_arch=linux-aarch64" >> $GITHUB_OUTPUT
                     echo "use_cross=true" >> $GITHUB_OUTPUT ;;
            mipsel)  echo "triple=mipsel-unknown-linux-musl" >> $GITHUB_OUTPUT
                     echo "client_arch=linux-mipsel" >> $GITHUB_OUTPUT
                     echo "use_cross=false" >> $GITHUB_OUTPUT ;;
            armv7)   echo "triple=armv7-unknown-linux-musleabihf" >> $GITHUB_OUTPUT
                     echo "client_arch=linux-armv7" >> $GITHUB_OUTPUT
                     echo "use_cross=true" >> $GITHUB_OUTPUT ;;
            x86_64)  echo "triple=x86_64-unknown-linux-musl" >> $GITHUB_OUTPUT
                     echo "client_arch=linux-x86_64" >> $GITHUB_OUTPUT
                     echo "use_cross=true" >> $GITHUB_OUTPUT ;;
          esac

      - name: Install cross
        if: steps.target.outputs.use_cross == 'true'
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install mipsel musl toolchain
        if: steps.target.outputs.use_cross == 'false'
        run: |
          rustup toolchain install nightly --profile minimal
          rustup +nightly component add rust-src
          MUSL_CROSS_URL="https://github.com/cross-tools/musl-cross/releases/download/20250929/mipsel-unknown-linux-musl.tar.xz"
          wget --tries=3 --timeout=60 -O /tmp/mipsel-musl.tar.xz "$MUSL_CROSS_URL"
          sudo mkdir -p /opt/mipsel-cross
          sudo tar xJf /tmp/mipsel-musl.tar.xz -C /opt/mipsel-cross --strip-components=1
          rm -f /tmp/mipsel-musl.tar.xz
          echo "/opt/mipsel-cross/bin" >> "$GITHUB_PATH"
          echo "--- sysroot diagnostics ---"
          /opt/mipsel-cross/bin/mipsel-unknown-linux-musl-gcc -print-sysroot || true
          find /opt/mipsel-cross -name 'crt1.o' 2>/dev/null | head -5
          /opt/mipsel-cross/bin/mipsel-unknown-linux-musl-gcc --version

      - name: Download pre-built TrustTunnelClient
        run: |
          ./scripts/download-client.sh \
            "${{ env.CLIENT_VERSION }}" \
            "${{ steps.target.outputs.client_arch }}" \
            "client_bin"

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ matrix.arch }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: cargo-${{ matrix.arch }}-

      - name: Build wrapper
        env:
          CARGO_TARGET_MIPSEL_UNKNOWN_LINUX_MUSL_LINKER: /opt/mipsel-cross/bin/mipsel-unknown-linux-musl-gcc
          CC_mipsel_unknown_linux_musl: /opt/mipsel-cross/bin/mipsel-unknown-linux-musl-gcc
          CARGO_TARGET_MIPSEL_UNKNOWN_LINUX_MUSL_RUSTFLAGS: -C link-arg=--sysroot=/opt/mipsel-cross/mipsel-unknown-linux-musl
        run: |
          if [ "${{ steps.target.outputs.use_cross }}" = "true" ]; then
            cross build --release --target ${{ steps.target.outputs.triple }}
          else
            cargo +nightly build --release --target ${{ steps.target.outputs.triple }} -Zbuild-std=std,panic_abort
          fi
          ls -lh target/${{ steps.target.outputs.triple }}/release/trusttunnel-keenetic

      - name: Package IPK
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="0.0.0-dev.${{ github.run_number }}"
          fi

          ./scripts/package-ipk.sh \
            "${{ matrix.arch }}" \
            "$VERSION" \
            "target/${{ steps.target.outputs.triple }}/release/trusttunnel-keenetic" \
            "client_bin"

      - name: Check size
        run: |
          for f in *.ipk; do
            SIZE=$(stat -c%s "$f")
            echo "Package: $f â€” $((SIZE/1024)) KB"
            if [ "$SIZE" -gt 10485760 ]; then
              echo "::warning::Package $f exceeds 10MB ($((SIZE/1024)) KB)"
            fi
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: trusttunnel-keenetic-${{ matrix.arch }}
          path: '*.ipk'
          retention-days: 30

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Checksums
        run: |
          cd artifacts
          sha256sum *.ipk > SHA256SUMS 2>/dev/null || true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.ipk
            artifacts/SHA256SUMS
          generate_release_notes: true
