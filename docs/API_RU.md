# API Reference (RU)

HTTP API для `trusttunnel-keenetic`. По умолчанию сервер слушает `http://0.0.0.0:8080`.

English version: [`API.md`](API.md)

## Авторизация

- `POST /api/login` и `GET /` доступны без токена.
- Для остальных `/api/*` нужен заголовок:

```text
Authorization: <session-token>
```

Токен выдаётся через `POST /api/login`. TTL сессии: 1 час, продлевается при активности.

### Быстрый шаблон для curl

```sh
BASE_URL="http://192.168.1.1:8080"
TOKEN="<session-token>"
```

---

## POST /api/login

Авторизация через NDM API роутера (challenge-response).

### Тело запроса

```json
{
  "login": "admin",
  "password": "secret"
}
```

### Ответы

| Код | Значение |
|-----|----------|
| 200 | Успешная авторизация |
| 400 | Некорректный JSON или нет `login/password` |
| 401 | Неверные учётные данные |

### Успешный ответ (200)

```json
{
  "token": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "status": "ok"
}
```

---

## GET /api/status

Текущий статус процесса `trusttunnel_client`.

### Успешный ответ (200)

```json
{
  "connected": true,
  "uptime_seconds": 3600,
  "last_error": "",
  "pid": 12345
}
```

---

## GET /api/config

Возвращает текущий объект `tunnel` из конфигурации wrapper.

---

## POST /api/config

Полностью заменяет блок `tunnel` и сохраняет конфиг на диск.

Важно: это не merge-обновление. Передавайте полный объект (как в `GET /api/config`).

### Ответы

| Код | Значение |
|-----|----------|
| 200 | Конфигурация обновлена |
| 400 | Некорректный JSON конфигурации |
| 500 | Ошибка сохранения |

### Успешный ответ (200)

```json
{
  "status": "updated"
}
```

---

## POST /api/control

Управление состоянием туннеля.

### Тело запроса

```json
{
  "action": "connect"
}
```

### Допустимые значения `action`

| Значение | Описание |
|----------|----------|
| `connect` | Запуск туннеля |
| `disconnect` | Остановка туннеля |
| `restart` | Перезапуск туннеля |

### Ответы

| Код | Значение |
|-----|----------|
| 200 | Действие принято |
| 400 | Некорректный JSON, неизвестное действие или ошибка запуска/рестарта |

---

## GET /api/logs

Возвращает последние строки логов из объединённых источников рантайма.

### Query-параметры

| Параметр | Тип | По умолчанию | Ограничение |
|----------|-----|--------------|-------------|
| `limit` | number | `100` | максимум `500` |

### Успешный ответ (200)

```json
{
  "lines": [
    "[tunnel] started PID 12345",
    "[routing] setup complete (WAN=eth0)"
  ],
  "total": 237
}
```

`total` — текущее количество строк во внутреннем буфере wrapper.

---

## GET /

Возвращает встроенный HTML интерфейса Web UI.

---

## Формат ошибок

```json
{
  "error": "описание ошибки"
}
```
